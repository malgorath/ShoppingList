<!doctype html>
<html lang="en" class="theme-dark">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link 
      rel="stylesheet" 
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" 
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" 
      crossorigin="anonymous"
    >

    <title>{% block title %}{% endblock %}</title>

    <style>
      /* Popup styling (theme-aware) */
      #aboutPopup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        background: var(--panel);
        color: var(--fg);
        border: 1px solid rgba(127,127,127,0.06);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 8px 24px rgba(2,6,23,0.12);
        width: 420px;
        text-align: center;
      }

      #aboutPopup img {
        width: 320px;
        max-width: 100%;
        margin-bottom: 12px;
        transition: opacity 220ms ease, transform 220ms ease;
      }

      #aboutPopup .close-btn {
        display: block;
        margin: 10px auto 0;
        padding: 6px 12px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      #aboutPopup .close-btn:hover { opacity:0.95 }

      /* Overlay styling */
      #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.45);
        z-index: 1040;
      }
    </style>
    <!-- DataTables CSS (Bootstrap 4) -->
  <!-- App styles (malgorath_suite) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <!-- DataTables CSS (Bootstrap 4) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css">
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md navbar-dark" id="mainNav">
      <div class="container">
      <a class="navbar-brand" href="#" onclick="showAboutPopup(); return false;" aria-label="About">
        <img src="{{ url_for('static', filename='images/dark-theme-lg.png') }}" alt="Logo" height="50" style="padding: 0px;">
      </a>
      <button 
        class="navbar-toggler" 
        type="button" 
        data-toggle="collapse" 
        data-target="#navbarNav" 
        aria-controls="navbarNav" 
        aria-expanded="false" 
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
        </ul>
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <button class="btn btn-link nav-link p-0" id="themeToggleBtn" aria-label="Toggle theme" title="Toggle theme">
              <!-- Sun (light) -->
              <span id="icon-sun" style="display:none; vertical-align:middle;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M6.995 12c0 2.761 2.246 5.007 5.005 5.007s5.005-2.246 5.005-5.007c0-2.761-2.246-5.005-5.005-5.005s-5.005 2.244-5.005 5.005zm13.005-.5h2v1h-2v-1zm-20 0h2v1h-2v-1zm10-9v2h-1v-2h1zm0 18v2h-1v-2h1zm7.071-14.071l1.414 1.414-.707.707-1.414-1.414.707-.707zm-12.142 12.142l1.414 1.414-.707.707-1.414-1.414.707-.707zm12.142 0l.707.707-1.414 1.414-.707-.707 1.414-1.414zm-12.142-12.142l.707.707-1.414 1.414-.707-.707 1.414-1.414z"/>
                </svg>
              </span>
              <!-- Moon (dark) -->
              <span id="icon-moon" style="display:inline-block; vertical-align:middle;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M21.64 13.03A9 9 0 0110.97 2.36a7 7 0 108.67 10.67z"/>
                </svg>
              </span>
            </button>
          </li>
          <!-- top Add Item removed (kept on page body) -->
        </ul>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      {# Toast container for flashes #}
      <div aria-live="polite" aria-atomic="true" style="position: relative; min-height: 100px;">
        <div style="position: absolute; top: 0; right: 0; z-index: 2000;">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
              {% set toast_class = 'bg-success text-white' if category == 'success' else 'bg-danger text-white' %}
              <div class="toast {{ toast_class }} m-2" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
                <div class="toast-body">{{ message }}</div>
              </div>
            {% endfor %}
          {% endwith %}
        </div>
      </div>

      {% block content %}{% endblock %}
    </div>

    <!-- About Popup -->
    <div id="overlay"></div>
    <div id="aboutPopup">
      <img id="aboutLogo" src="{{ url_for('static', filename='images/dark-theme-lg.png') }}" alt="Logo">
      <p>Basic Example of Flask/Jinja to demonstrate sqlite3 usage.<br>Visit my projects at <a class="nav-link" href="https://github.com/malgorath">GitHub</a></p>
      <button class="close-btn" onclick="hideAboutPopup()">Close</button>
    </div>

    <!-- Add Item Modal (SPA) -->
    <div class="modal fade" id="addItemModal" tabindex="-1" role="dialog" aria-labelledby="addItemModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addItemModalLabel">Add New Item</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <form id="addItemForm" method="POST" action="{{ url_for('add_item') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="modal-body">
              <div class="form-group">
                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" name="title" required>
              </div>
              <div class="form-group">
                <label for="content">Description</label>
                <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
              </div>
              <div class="form-group">
                <label for="price">Price</label>
                <input type="number" step="0.01" class="form-control" id="price" name="price" value="0.00" required>
              </div>
              <div class="form-group">
                <label for="purchase_by">Purchase By</label>
                <input type="date" class="form-control themed-input" id="purchase_by" name="purchase_by">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Add Item</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- Use full jQuery (required for AJAX and DataTables) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
    <script 
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" 
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" 
      crossorigin="anonymous"
    ></script>
    <script 
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" 
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" 
      crossorigin="anonymous"
    ></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>

    <script>
      // Helper to initialize DataTables on tables with id
      function initDataTable(selector) {
        jQuery(selector).DataTable({
          pageLength: 25,
          lengthMenu: [[5,10,25,50,100,-1],[5,10,25,50,100,'All']],
          responsive: true
        });
      }
    </script>

    <!-- Delete confirmation modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalLabel">Confirm Delete</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this item?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global delete modal handler: when a .delete-btn is clicked, store id and show modal
      let pendingDeleteId = null;
      jQuery(document).on('click', '.delete-btn', function(e){
        e.preventDefault();
        pendingDeleteId = jQuery(this).data('id');
        jQuery('#deleteConfirmModal').modal('show');
      });

      jQuery('#confirmDeleteBtn').on('click', function(){
        if(!pendingDeleteId) return;
        const id = pendingDeleteId;
        jQuery('#deleteConfirmModal').modal('hide');
        // perform AJAX delete
        jQuery.ajax({
          url: '/delete/' + id,
          method: 'POST',
          headers: { 'X-CSRF-Token': '{{ csrf_token }}', 'X-Requested-With': 'XMLHttpRequest' },
          success: function(){
            // reload the DataTable if present
            if(jQuery.fn.DataTable.isDataTable('#shoppingTable')){
              jQuery('#shoppingTable').DataTable().ajax.reload(null,false);
            } else {
              location.reload();
            }
          },
          error: function(){
            alert('Failed to delete item');
          }
        });
        pendingDeleteId = null;
      });
    </script>

    <script>
      function showAboutPopup() {
        document.getElementById('aboutPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
      }

      function hideAboutPopup() {
        document.getElementById('aboutPopup').style.display = 'none';
        document.getElementById('overlay').style.display = 'none';
      }
    </script>
    <script>
      // Initialize Bootstrap toasts
      jQuery(function(){
        jQuery('.toast').toast('show');
      });

      // Theme toggle (persist in localStorage) — default to dark
      function setTheme(dark){
        var $logo = jQuery('.navbar-brand img');
        var $about = jQuery('#aboutLogo');
        if(dark){
          document.documentElement.classList.add('theme-dark');
          $logo.attr('src', "{{ url_for('static', filename='images/dark-theme-lg.png') }}");
          if($about.length) $about.attr('src', "{{ url_for('static', filename='images/dark-theme-lg.png') }}");
          jQuery('#icon-moon').show();
          jQuery('#icon-sun').hide();
          localStorage.setItem('theme','dark');
        } else {
          document.documentElement.classList.remove('theme-dark');
          $logo.attr('src', "{{ url_for('static', filename='images/light-theme-lg.png') }}");
          if($about.length) $about.attr('src', "{{ url_for('static', filename='images/light-theme-lg.png') }}");
          jQuery('#icon-moon').hide();
          jQuery('#icon-sun').show();
          localStorage.setItem('theme','light');
        }
      }

      jQuery(function(){
        var theme = localStorage.getItem('theme') || 'dark';
        setTheme(theme === 'dark');
        jQuery('#themeToggleBtn').on('click', function(e){
          e.preventDefault();
          setTheme(document.documentElement.classList.contains('theme-dark') ? false : true);
        });
      });
    </script>

    {# Page-specific scripts (rendered after jQuery & dependencies) #}
    {% block page_scripts %}{% endblock %}
    <script>
      // When the add modal opens, set purchase_by default to 7 days from today
      jQuery('#addItemModal').on('show.bs.modal', function (e) {
        var $date = jQuery('#purchase_by');
        if ($date.length) {
          if (!$date.val()) {
            var dt = new Date();
            dt.setDate(dt.getDate() + 7);
            var y = dt.getFullYear();
            var m = ('0' + (dt.getMonth()+1)).slice(-2);
            var d = ('0' + dt.getDate()).slice(-2);
            $date.val(y + '-' + m + '-' + d);
          }
        }
      });
    </script>
  </body>
</html>